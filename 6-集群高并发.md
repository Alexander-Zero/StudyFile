# 集群高并发

## 网络协议

四层通信模型

每一层都有不同的协议

应用层:　http,  ssh, smtp, 等

传输控制层：TCP , UDP

TCP: 三次握手 -> 数据传输 -> 四次分手, 最小粒度, 端点到端点的传输协议不能被打散

网络层：路由

链路层：

物理层：





每一层都有一张表,

网络层, 路由表, route -n 

下一跳, 每个主机不会存储所有的网络节点, 只会存距离为1的网络

路由判定, 按位与

网络层只解决下一跳





链路层: mack地址,  arp -a 



tcp/ip 基于吓一跳机制

ip,port是基于两端点

mack是基于节点间的, 每下一跳 换一个 mack , 包中是下一跳的地址





arp协议:　

刚开机:获取网关mac流程  　电脑发送gateway + mac(ffffff) -> 交换机广播 -> gateway响应 -> gateway发送 本机mac到主机 

arp包内容:  源ip + 源mac + 目标ip + 目标mac

 交换机????? : 同一网络, 无路由表

路由器  ： 不同网络 , 有路由表 



NAT :　网络地址转换协议

DR: 直接路由模式

TUN: 隧道模式, 有点装饰者模式的感觉

VPN: 



LVS配置步骤

node01为 server, node02/node03为client

>1 : 设置LVS Server的网卡
>
> ifconfig eth0:2 192.168.1.200/24    或   ifconfig eth0:2 192.168.1.200 netmask 255.255.255.0
>
>2 :  修改LVS Client 网卡隐藏设置
>
>echo 1 > /proc/sys/net/ipv4/conf/eth0/arp_ignore
>
>echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore
>
>echo 2 > /proc/sys/net/ipv4/conf/eth0/arp_announce
>
>echo 2 > /proc/sys/net/ipv4/conf/all/arp_ignore
>
>3 : 创建LVS Client网卡
>
>ifconfig lo:2 192.168.1.200 netmask 255.255.255.255
>
>4 : 





隐藏vip

lvs server: NODE 01

>非持久化,重启会消失
>
>1.设置vip
>
>2.其他配置好后  yum install ipvsadm -y
>
>ipvsadm -A -t 192.168.1.100:80 -s rr : -A 包进入规则 -t TCP   -s规则 rr轮询
>
>ipvsadm -ln : 查看
>
>ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.12 -g -w  1   :　-a : 出包规则,  -r: RIP地址
>
>ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.13 -g -w  1
>
>验证 broswer访问 192.168.1.100 
>
>node 01 : netstat -natp  看不到连接
>
>node 02 : netstat -natp 能看到连接
>
>node01: ipvsadm -lnc : 查看统计
>
>ifconfig eth0:2 down

ifconfig eth0:2 192.168.1.100/24  或者  ifconfig eth0:2 192.168.1.100 netmask 255.255.255.0



lvs client: NODE 02/03/04

> 1.修改内核
>
> 2.设置vip
>
> 3.安装httpd     yum install httpd -y  启动

cd /proc/sys/net/ipv4/conf/

cd eth0

修改 arp_ignore -> 1

echo 1 >  arp_ignore

echo 2 > arp_announce

cd ../all

echo 1 >  arp_ignore

echo 2 > arp_announce

ifconfig lo:2 192.168.1.100 netmask 255.255.255.255   (不是255.255.255.0 防止死循环)



LVS 简写

echo 1 > /proc/sys/net/ipv4/conf/eth0/arp_ignore

echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore

echo 2 > /proc/sys/net/ipv4/conf/eth0/arp_announce

echo 2 > /proc/sys/net/ipv4/conf/all/arp_ignore

ifconfig lo:8  192.168.1.100 netmask 255.255.255.0







第四课

LVS问题

>1: 单点故障, 服务不可用
>
>2: RS 挂掉,部分服务不可用
>
>ipvsadm -C
>
>ifconfig eth0 down 
>
>yum install keepalived ipvsadm -y
>
>cp /etc/keepalived/keepalived.conf  /etc/keepalived/keepalived.conf.back 
>
>vim /etc/keepalived/keepalived.conf



问题:  keepalived 异常退出, 两边都有vip, 



keepalived 启动后能正常飘逸vip

但是vip无法ping 通

vrrp_strict

https://blog.csdn.net/wade1010/article/details/88863780











